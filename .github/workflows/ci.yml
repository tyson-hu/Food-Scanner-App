name: CI

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build & Unit Tests (fast)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode 26
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.0'

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}-xcode-26.0
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ./DerivedData
          key: ${{ runner.os }}-dd-${{ hashFiles('**/Package.resolved') }}-xcode-26.0
          restore-keys: |
            ${{ runner.os }}-dd-

      - name: Resolve packages
        run: xcodebuild -resolvePackageDependencies -scheme "Food Scanner"

      - name: Build & Unit Tests (no coverage, unit only)
        run: |
          set -eo pipefail
          xcodebuild             -scheme "Food Scanner"             -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.0'             -derivedDataPath ./DerivedData             -only-testing:FoodScannerTests             CODE_SIGNING_ALLOWED=NO             SWIFT_STRICT_CONCURRENCY=complete             OTHER_SWIFT_FLAGS='-warnings-as-errors'             -parallel-testing-enabled YES             -maximum-concurrent-test-simulator-destinations 2             test | xcpretty
        shell: bash

  lint:
    name: Lint (SwiftFormat + SwiftLint)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install SwiftLint & SwiftFormat
        run: |
          brew install swiftlint swiftformat
      - name: SwiftFormat (lint only)
        run: |
          swiftformat --lint "Food Scanner" || exit 1
          swiftformat --lint "FoodScannerTests" || exit 1
          swiftformat --lint "FoodScannerUITests" || exit 1
      - name: SwiftLint (strict)
        run: swiftlint --strict

  guards:
    name: Guards (no TODO/FIXME, no legacy APIs)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail on TODO/FIXME
        run: |
          if grep -RIn --exclude-dir=.build --exclude-dir=DerivedData -E 'TODO|FIXME' "Food Scanner" FoodScannerTests; then
            echo "::error::Found TODO/FIXME. Please resolve or annotate."; exit 1; fi
      - name: Ban legacy APIs
        run: |
          if grep -RIn -E 'UIWebView|NSURLConnection' "Food Scanner"; then
            echo "::error::Legacy API detected."; exit 1; fi

  codeql:
    name: CodeQL (Swift) â€” pinned to Xcode 16
    runs-on: macos-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      # Workaround current incompatibility of CodeQL Swift with Xcode 26.
      # See: https://github.com/github/codeql-action/issues/3111
      - name: Setup Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Init CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: swift
          build-mode: manual

      - name: Resolve packages
        run: xcodebuild -resolvePackageDependencies -scheme "Food Scanner"

      - name: Build for CodeQL (compile only)
        run: |
          set -eo pipefail
          xcodebuild             -scheme "Food Scanner"             -sdk iphonesimulator             -destination 'generic/platform=iOS Simulator'             -configuration Debug             -derivedDataPath ./DerivedData             CODE_SIGNING_ALLOWED=NO             build | xcpretty

      - name: Analyze
        uses: github/codeql-action/analyze@v3
